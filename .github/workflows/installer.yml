name: Create Installer

on:
    push:
        branches: [main]
        tags: ["v*"]
    pull_request:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-and-install:
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [windows-latest, ubuntu-latest]
                include:
                    - os: windows-latest
                      runtime: win-x64
                      main_exe: NeroiStack.exe
                      icon_ext: .ico
                    - os: ubuntu-latest
                      runtime: linux-x64
                      main_exe: NeroiStack
                      icon_ext: .png
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Restore Dependencies
              run: dotnet restore NeroiStack.sln

            - name: Publish Application
              run: |
                  dotnet publish NeroiStack/NeroiStack.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish

            - name: Get Version
              id: get_version
              shell: bash
              run: |
                  VERSION=${GITHUB_REF_NAME#v}
                  if [[ $VERSION == main || $VERSION == master || $VERSION != [0-9]* ]]; then
                    VERSION="0.0.1"
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

            - name: Install Velopack CLI
              run: dotnet tool install -g vpk

            - name: Build Installer (Velopack)
              shell: bash
              run: |
                  if [ "$RUNNER_OS" == "Linux" ]; then
                    sudo apt-get update
                    sudo apt-get install -y libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-xinput0 libxcb-shape0 fuse
                  fi
                  vpk pack \
                    --packId NeroiStack \
                    --packVersion ${{ steps.get_version.outputs.VERSION }} \
                    --packDir ./publish \
                    --mainExe ${{ matrix.main_exe }} \
                    --packAuthors "TseWei Chen" \
                    --icon NeroiStack/Assets/NeroiStack${{ matrix.icon_ext }} \
                    --outputDir ./releases

            - name: Upload Installer to Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: NeroiStack-Installer-${{ matrix.runtime }}
                  path: ./releases/*
                  if-no-files-found: error

            - name: Release Installer
              uses: softprops/action-gh-release@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  files: |
                      ./releases/*.exe
                      ./releases/*.AppImage
                      ./releases/*-Portable.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
