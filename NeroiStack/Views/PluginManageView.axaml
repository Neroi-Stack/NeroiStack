<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:NeroiStack.ViewModels"
             xmlns:model="using:NeroiStack.Agent.Model"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="NeroiStack.Views.PluginManageView"
             x:DataType="vm:PluginManageViewModel">
	<UserControl.Resources>
        
	</UserControl.Resources>

	<UserControl.DataTemplates>
		<DataTemplate DataType="{x:Type model:PluginMcpHttpVM}">
			<StackPanel>
				<SelectableTextBlock Text="Endpoint"/>
				<TextBox Text="{Binding Endpoint}"/>
				<SelectableTextBlock Text="API Key"/>
				<TextBox Text="{Binding ApiKey}" PasswordChar="*"/>
			</StackPanel>
		</DataTemplate>
		<DataTemplate DataType="{x:Type model:ChPluginMcpStdioVM}">
			<StackPanel>
				<SelectableTextBlock Text="Command"/>
				<TextBox Text="{Binding Command}"/>
				<SelectableTextBlock Text="Arguments (one per line)"/>
				<TextBox Text="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).McpStdioArguments}" AcceptsReturn="True" Height="80"/>
			</StackPanel>
		</DataTemplate>
		<DataTemplate DataType="{x:Type model:ChPluginOpenApiVM}">
			<StackPanel>
				<SelectableTextBlock Text="URI"/>
				<TextBox Text="{Binding Uri}"/>
				<SelectableTextBlock Text="Auth Type"/>
				<ComboBox SelectedIndex="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).OpenApiAuthType}">
					<ComboBoxItem>No Auth</ComboBoxItem>
					<ComboBoxItem>API Key</ComboBoxItem>
					<ComboBoxItem>Bearer Token</ComboBoxItem>
				</ComboBox>
				<StackPanel IsVisible="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).IsApiKeyAuth}">
					<SelectableTextBlock Text="API Key"/>
					<TextBox Text="{Binding ApiKey}" PasswordChar="*"/>
				</StackPanel>
				<StackPanel IsVisible="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).IsBearerTokenAuth}">
					<SelectableTextBlock Text="Bearer Token"/>
					<TextBox Text="{Binding BearerToken}" PasswordChar="*"/>
				</StackPanel>
			</StackPanel>
		</DataTemplate>
	</UserControl.DataTemplates>

	<UserControl.Styles>
		<Style Selector="Button.Link">
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="Padding" Value="5"/>
			<Setter Property="Cursor" Value="Hand"/>
		</Style>
		
		<Style Selector="Border.Card">
			<Setter Property="Background" Value="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"/>
			<Setter Property="CornerRadius" Value="8"/>
			<Setter Property="Padding" Value="15"/>
			<Setter Property="Margin" Value="10"/>
			<Setter Property="BoxShadow" Value="0 4 8 0 #000000"/>
		</Style>
	</UserControl.Styles>

	<Grid>
		<Grid RowDefinitions="Auto, *">
			<!-- Header -->
			<Grid Grid.Row="0" ColumnDefinitions="*, Auto" Margin="20">
				<SelectableTextBlock Text="Plugins" FontSize="24" FontWeight="Bold" VerticalAlignment="Center"/>
				<Button Grid.Column="1" Command="{Binding CreateCommand}" Classes="accent" Content="New Plugin"/>
			</Grid>

			<!-- Content -->
			<ScrollViewer Grid.Row="1" Padding="20">
				<ItemsControl ItemsSource="{Binding Plugins}">
					<ItemsControl.ItemsPanel>
						<ItemsPanelTemplate>
							<WrapPanel ItemWidth="300" />
						</ItemsPanelTemplate>
					</ItemsControl.ItemsPanel>
					<ItemsControl.ItemTemplate>
						<DataTemplate>
							<Border Classes="Card" Width="280" Height="150">
								<Grid RowDefinitions="Auto, *, Auto">
									<Grid Grid.Row="0" ColumnDefinitions="*, Auto">
										<StackPanel>
											<SelectableTextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="16"/>
											<SelectableTextBlock Text="{Binding Type}" FontSize="12" Foreground="Gray"/>
										</StackPanel>
										<Button Grid.Column="1" Classes="Link" Content="â‹®">
											<Button.Flyout>
												<MenuFlyout>
													<MenuItem Header="Edit" Command="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).EditCommand}" CommandParameter="{Binding}" />
													<MenuItem Header="Delete" Command="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).DeleteCommand}" CommandParameter="{Binding}" />
												</MenuFlyout>
											</Button.Flyout>
										</Button>
									</Grid>

									<SelectableTextBlock Grid.Row="1" Text="{Binding Description}" TextWrapping="Wrap" Margin="0,10" Foreground="#CCCCCC"/>

									<Grid Grid.Row="2" ColumnDefinitions="Auto, *">
										<ToggleSwitch IsChecked="{Binding IsEnabled}" OnContent="On" OffContent="Off" Command="{Binding $parent[UserControl].((vm:PluginManageViewModel)DataContext).ToggleEnableCommand}" CommandParameter="{Binding}"/>
									</Grid>
								</Grid>
							</Border>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>
		</Grid>

		<!-- Modal Overlay -->
		<Grid Background="#AA000000" IsVisible="{Binding IsModalOpen}">
			<!-- Editor Modal -->
			<Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="8" Width="500" VerticalAlignment="Center" HorizontalAlignment="Center" IsVisible="{Binding IsEditorVisible}">
				<Grid RowDefinitions="Auto, *, Auto" Margin="20">
					<SelectableTextBlock Grid.Row="0" Text="{Binding ModalTitle}" FontSize="20" FontWeight="Bold" Margin="0,0,0,15"/>
					
					<ScrollViewer Grid.Row="1" MaxHeight="500">
						<StackPanel Spacing="10">
							<SelectableTextBlock Text="Name"/>
							<TextBox Text="{Binding CurrentPlugin.Name}"/>
							
							<SelectableTextBlock Text="Description"/>
							<TextBox Text="{Binding CurrentPlugin.Description}" AcceptsReturn="True" Height="60"/>
							
							<SelectableTextBlock Text="Type" IsVisible="{Binding IsCreating}"/>
							<ComboBox ItemsSource="{Binding PluginTypes}" SelectedItem="{Binding SelectedPluginType}" IsVisible="{Binding IsCreating}" HorizontalAlignment="Stretch"/>
							<SelectableTextBlock Text="{Binding CurrentPlugin.Type}" IsVisible="{Binding !IsCreating}" Foreground="Gray"/>

							<!-- Type Specific Fields via ContentControl -->
							<ContentControl Content="{Binding CurrentPlugin}" Margin="0,10,0,0"/>
						</StackPanel>
					</ScrollViewer>

					<StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,15,0,0">
						<Button Content="Cancel" Command="{Binding CloseModalCommand}"/>
						<Button Content="Save" Command="{Binding SaveCommand}" Classes="accent"/>
					</StackPanel>
				</Grid>
			</Border>

			<!-- Delete Confirmation -->
			<Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="8" Width="300" VerticalAlignment="Center" HorizontalAlignment="Center" IsVisible="{Binding IsDeleteConfirmVisible}">
				<Grid RowDefinitions="Auto, Auto, Auto" Margin="20">
					<SelectableTextBlock Grid.Row="0" Text="Delete Plugin" FontSize="18" FontWeight="Bold"/>
					<SelectableTextBlock Grid.Row="1" Text="Are you sure you want to delete this plugin?" Margin="0,15"/>
					<StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
						<Button Content="Cancel" Command="{Binding CloseModalCommand}"/>
						<Button Content="Delete" Command="{Binding ConfirmDeleteCommand}" Background="{DynamicResource SystemControlErrorTextForegroundBrush}" Foreground="{DynamicResource SystemControlBackgroundAltHighBrush}"/>
					</StackPanel>
				</Grid>
			</Border>
		</Grid>
	</Grid>
</UserControl>
